generator client {
  provider = "prisma-client-js"
}

// Add a check for node_env to determine whoch db to use 

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Bookmark {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title       String
  description String
  link        String
}

model User {
  id String @id @default(uuid())

  first_name                   String?
  last_name                    String?
  cardholder_id                String?
  email                        String?           @unique
  smipay_tag                   String?          @unique
  fourDigitPin                 String?
  transactionPinHash           String?
  hash                         String?
  phone_number                 String
  middle_name                  String?
  is_friendly                  Boolean          @default(false)
  referral_code                String?
  password                     String?
  otp                          String?
  otp_expires_at               DateTime?
  role                         Role?            @default(user)
  gender                       Gender?
  date_of_birth                DateTime?
  profile_image                ProfileImage?
  address                      Address?
  is_email_verified            Boolean          @default(false)
  agree_to_terms               Boolean          @default(false)
  updates_opt_in               Boolean          @default(false)
  is_phone_verified            Boolean          @default(false)
  kyc_verification             KycVerification?
  wallet                       Wallet?
  refreshToken                 RefreshToken?
  paystack_customer_code       String?          @unique
  account_status               AccountStatus?   @default(active)
  password_attempts            Int              @default(0)
  password_attempts_started_at DateTime?
  tier_id                      String?
  tier                         Tier?            @relation("UserTier", fields: [tier_id], references: [id], onDelete: SetNull)
  createdAt                    DateTime         @default(now())
  updatedAt                    DateTime         @updatedAt

  accounts Account[] @relation("UserAccounts")
  cards    Card[]

  temp_flw_accts FlwTempAcctNumber[] @relation("generatedFlwAccts")
  deviceTokens   DeviceToken[]

  // Referral relationships
  referrals_given    Referral[]       @relation("Referrer") // Referrals this user gave
  referrals_received Referral[]       @relation("Referee") // Referrals this user received
  userDevices        UserDevice[]     @relation("UserDevices")
  supportTickets     SupportTicket[]  @relation("UserSupportTickets")
  supportMessages    SupportMessage[] @relation("UserSupportMessages")
}

model ProfileImage {
  id         String @id @default(uuid())
  userId     String @unique
  secure_url String
  public_id  String
  user       User   @relation(fields: [userId], references: [id])
}

model Address {
  id           String  @id @default(uuid())
  userId       String  @unique
  city         String?
  state        String?
  country      String?
  home_address String?
  house_number String?
  postal_code  String?
  user         User    @relation(fields: [userId], references: [id])
}

model KycVerification {
  id                   String       @id @default(uuid())
  userId               String       @unique
  first_name           String?
  last_name            String?
  middle_name          String?
  phone                String?
  email                String?
  date_of_birth        DateTime?
  gender               String?
  nin                  String?
  state_of_origin      String?
  lga_of_origin        String?
  state_of_residence   String?
  lga_of_residence     String?
  watchlisted          Boolean      @default(false)
  face_image           String?
  is_verified          Boolean      @default(false)
  id_type              KycIdType?
  id_no                String
  bvn                  String?
  bvn_verified         Boolean      @default(false)
  status               KycIdStatus?
  bvn_verification_url String?
  bvn_flw_reference    String?
  initiated_at         DateTime     @default(now())
  approved_at          DateTime?
  failure_reason       String?
  user                 User         @relation(fields: [userId], references: [id])
}

enum Role {
  user
  admin
  super_admin
}

enum Gender {
  male
  female
}

enum AccountStatus {
  active
  suspended
}

enum KycIdStatus {
  pending
  approved
  rejected
}

enum KycIdType {
  NIGERIAN_BVN_VERIFICATION
  NIGERIAN_NIN
  NIGERIAN_INTERNATIONAL_PASSPORT
  NIGERIAN_PVC
  NIGERIAN_DRIVERS_LICENSE
}

enum VerificationStatus {
  pending
  verified
  failed
  rejected
}

enum StepStatus {
  not_started
  pending
  completed
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt], map: "expires_at_idx")
}

// Transaction Table

model TransactionHistory {
  id               String           @id @default(uuid())
  account_id       String?
  user_id          String
  amount           Float?
  vtpass_amount    Float? // raw amount sent to VTpass (from variation)
  smipay_amount    Float? // amount charged to customer (after markup)
  markup_percent   Float? // percent applied (general or friendlies)
  markup_value     Float? // smipay_amount - vtpass_amount
  transaction_type TransactionType?
  credit_debit     CreditDebit?
  description      String?

  status                TransactionStatus? @default(pending)
  sender_details        SenderDetails?
  recipient_mobile      String?
  currency_type         CurrencyType?      @default(ngn)
  payment_method        PaymentMethod?     @default(paystack)
  payment_channel       PaymentChannel?
  icon                  TransactionIcon?
  fee                   Float?             @default(0.0)
  balance_before        Float              @default(0)
  balance_after         Float              @default(0)
  transaction_number    String?
  transaction_reference String?            @unique
  authorization_url     String?
  session_id            String?
  meta_data             Json?              @default("{}")
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
}

enum TransactionType {
  transfer
  deposit
  airtime
  data
  cable
  education
  betting
}

enum CreditDebit {
  credit
  debit
}

enum TransactionStatus {
  pending
  success
  failed
  cancelled
}

enum CurrencyType {
  ngn
  usd
  gbp
  eur
}

enum PaymentMethod {
  paystack
  card
  bank_transfer
  wallet
  ussd
}

enum PaymentChannel {
  bank_transfer
  smipay_tag
  paystack
  flutterwave
  other
}

model SenderDetails {
  id                    String             @id @default(uuid())
  transaction_id        String             @unique
  sender_name           String
  sender_bank           String
  sender_account_number String
  transaction           TransactionHistory @relation(fields: [transaction_id], references: [id], onDelete: Cascade)
}

model TransactionIcon {
  id             String             @id @default(uuid())
  transaction_id String             @unique
  secure_url     String
  public_id      String
  transaction    TransactionHistory @relation(fields: [transaction_id], references: [id])
}

model Account {
  id                   String        @id @default(uuid())
  user_id              String
  flw_response_code    String?
  flw_response_message String?
  account_number       String?
  frequency            Int?
  note                 String?
  accountType          AccountType?  @default(savings)
  currency             CurrencyType?
  bank_name            String?
  sort_code            String?
  routing_number       String?
  swift_code           String?
  country              String?
  iban                 String?
  account_name         String?
  reference            String?
  order_ref            String?
  flutterwave_id       String?
  bank_code            String?
  current_balance      Float         @default(0)
  balance_before       Float         @default(0)
  balance_after        Float         @default(0)
  isActive             Boolean       @default(true)
  account_status       String?       @default("active")
  meta_data            Json?         @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("UserAccounts", fields: [user_id], references: [id]) // Corrected relation
}

enum AccountType {
  savings
  current
  investment
}

model Wallet {
  id                 String  @id @default(uuid())
  user_id            String  @unique
  current_balance    Float   @default(0)
  all_time_fuunding  Float   @default(0)
  all_time_withdrawn Float   @default(0)
  isActive           Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id])
}

model Card {
  id                    String              @id @default(uuid())
  user_id               String
  bridge_card_id        String?
  bridge_cardholder_id  String?             @default("null")
  card_currency         BridgeCurrencyType?
  masked_pan            String?
  expiry_month          String?
  expiry_year           String?
  card_type             String?
  first_funding_amount  Float?
  card_limit            Float?
  current_balance       Float?
  balance_before        Float?
  transaction_reference String?
  balance_after         Float?
  card_name             String?
  card_brand            String?
  card_last4            String?
  status                String?
  is_active             Boolean             @default(true)
  metadata              Json?               @default("{}")
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  user User @relation(fields: [user_id], references: [id])
}

enum BridgeCurrencyType {
  NGN
  USD
  GBP
  EUR
}

model FlwTempAcctNumber {
  id             String  @id @default(uuid())
  response_code  String?
  flw_ref        String?
  order_ref      String?
  order_no       String?
  account_number String?
  accountStatus  String?
  frequency      Int?
  bank_name      String?
  note           String?
  amount         Float?
  status         String?
  meta_data      Json?

  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user_id String
  user    User   @relation("generatedFlwAccts", fields: [user_id], references: [id])
}

// Push Notification Device Tokens
model DeviceToken {
  id          String   @id @default(uuid())
  user_id     String
  token       String   @unique
  platform    Platform
  is_active   Boolean  @default(true)
  device_id   String? // Optional device identifier
  app_version String? // Optional app version
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
}

// User Device Management (for viewing, removing, restricting devices)
model UserDevice {
  id      String @id @default(uuid())
  user_id String
  user    User   @relation("UserDevices", fields: [user_id], references: [id], onDelete: Cascade)

  // Device identification
  device_id          String // Unique device identifier from device_metadata
  device_fingerprint String? // Device fingerprint for security

  // Device information (from device_metadata)
  device_name  String? // e.g., "John's iPhone"
  device_model String? // e.g., "iPhone 14 Pro"
  platform     Platform // ios or android
  os_name      String? // e.g., "iOS"
  os_version   String? // e.g., "17.2"
  app_version  String? // e.g., "1.0.0"

  // Device status
  is_active         Boolean @default(true) // Device is active/trusted
  is_restricted     Boolean @default(false) // Device is restricted/blocked
  is_current_device Boolean @default(false) // Is this the current device making the request

  // Location & Network
  last_ip_address String?
  last_location   String? // e.g., "Lagos, Nigeria"

  // Timestamps
  first_seen_at DateTime  @default(now()) // When device was first registered
  last_seen_at  DateTime  @default(now()) // Last time device was used
  restricted_at DateTime? // When device was restricted
  restricted_by String? // User ID or admin who restricted it

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([user_id, device_id]) // One record per device per user
  @@index([user_id])
  @@index([device_id])
  @@index([is_active])
  @@index([is_restricted])
  @@index([last_seen_at])
}

enum Platform {
  ios
  android
}

// Registration Progress Tracking
model RegistrationProgress {
  id           String @id @default(uuid())
  phone_number String @unique
  current_step Int    @default(1)
  total_steps  Int    @default(9)

  // Step statuses (replaces boolean completed flags)
  step_1_status StepStatus @default(not_started)
  step_2_status StepStatus @default(not_started)
  step_3_status StepStatus @default(not_started)
  step_4_status StepStatus @default(not_started)
  step_5_status StepStatus @default(not_started)
  step_6_status StepStatus @default(not_started)
  step_7_status StepStatus @default(not_started)
  step_8_status StepStatus @default(not_started)
  step_9_status StepStatus @default(not_started)

  // Registration data (JSON for flexibility)
  registration_data Json @default("{}")

  // Referral code
  referral_code String?

  // Verification statuses
  is_phone_verified        Boolean             @default(false)
  id_verification_status   VerificationStatus?
  face_verification_status VerificationStatus?

  // OTP for phone verification
  otp            String?
  otp_expires_at DateTime?

  // Metadata
  is_complete           Boolean   @default(false)
  expires_at            DateTime?
  verification_attempts Int       @default(0)

  // Device metadata
  device_metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone_number])
  @@index([is_complete])
  @@index([is_phone_verified])
}

// Referral Tracking
model Referral {
  id String @id @default(uuid())

  // Referrer (the person who owns the referral code)
  referrer_id String
  referrer    User   @relation("Referrer", fields: [referrer_id], references: [id], onDelete: Cascade)

  // Referee (the person who used the referral code)
  referee_phone_number String // Phone number from registration (before user is created)
  referee_user_id      String? // User ID after registration is complete (null until user completes registration)
  referee              User?   @relation("Referee", fields: [referee_user_id], references: [id], onDelete: SetNull)

  // Referral code used
  referral_code_used String

  // Status
  is_active       Boolean   @default(true)
  reward_given    Boolean   @default(false)
  reward_amount   Decimal?  @db.Decimal(10, 2)
  reward_given_at DateTime?

  // Metadata
  registration_progress_id String? // Link to registration progress
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@unique([referee_phone_number, referrer_id]) // One referral per phone per referrer
  @@index([referrer_id])
  @@index([referee_user_id])
  @@index([referee_phone_number])
  @@index([is_active])
  @@index([reward_given])
}

// Security Events Logging
model SecurityEvent {
  id String @id @default(uuid())

  // Event identification
  event_type     String // e.g., 'device_change', 'rate_limit_exceeded', 'suspicious_activity'
  event_category String // e.g., 'registration', 'authentication', 'transaction', 'fraud'
  severity       String // 'low', 'medium', 'high', 'critical'

  // Context
  phone_number             String? // Phone number if available (for registration events)
  user_id                  String? // User ID if available (for authenticated events)
  registration_progress_id String? // Link to registration progress if applicable

  // Device & Network Info
  device_id          String?
  device_fingerprint String?
  ip_address         String?
  user_agent         String?

  // Event details
  description String
  metadata    Json? // Additional event data (device info, previous values, etc.)

  // Status
  is_resolved      Boolean   @default(false)
  resolved_at      DateTime?
  resolved_by      String? // Admin user ID or system
  resolution_notes String?

  createdAt DateTime @default(now())

  @@index([event_type])
  @@index([event_category])
  @@index([severity])
  @@index([phone_number])
  @@index([user_id])
  @@index([registration_progress_id])
  @@index([device_id])
  @@index([ip_address])
  @@index([is_resolved])
  @@index([createdAt])
}

// Customer Support Ticket System
model SupportTicket {
  id String @id @default(uuid())

  // Ticket identification
  ticket_number String @unique // Auto-generated unique ticket number (e.g., "SMI-2025-001234")

  // User information
  user_id      String? // User ID if ticket is from registered user
  user         User?   @relation("UserSupportTickets", fields: [user_id], references: [id], onDelete: SetNull)
  phone_number String? // Phone number for unregistered users or additional contact
  email        String? // Email for contact and notifications

  // Ticket content
  subject     String // Brief summary of the issue
  description String @db.Text // Detailed description of the issue

  // Classification
  support_type SupportType // Type of support request (REGISTRATION_ISSUE, etc.)
  status       TicketStatus   @default(pending) // Current status of the ticket
  priority     TicketPriority @default(medium) // Priority level

  // Assignment & Resolution
  assigned_to      String? // Admin user ID who is handling the ticket
  resolved_at      DateTime?
  resolved_by      String? // Admin user ID who resolved the ticket
  resolution_notes String?   @db.Text // Notes on how the issue was resolved

  // Related entities (for context)
  related_transaction_id           String? // Link to TransactionHistory if related to a transaction
  related_registration_progress_id String? // Link to RegistrationProgress if related to registration

  // Context & Metadata
  device_metadata Json? // Device information when ticket was created
  ip_address      String? // IP address of the user
  user_agent      String? // Browser/app user agent

  // Additional information
  tags           Json? // Array of tags for categorization (e.g., ["urgent", "payment", "bug"])
  internal_notes String? @db.Text // Internal notes visible only to support team
  attachments    Json? // Array of attachment URLs/metadata

  // Response tracking
  first_response_at     DateTime? // When support team first responded
  last_response_at      DateTime? // When last response was made
  response_time_seconds Int? // Calculated response time in seconds

  // Feedback & Satisfaction
  satisfaction_rating Int? // 1-5 rating from user
  feedback            String? @db.Text // User feedback after resolution

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages SupportMessage[] // Conversation thread

  @@index([ticket_number])
  @@index([user_id])
  @@index([phone_number])
  @@index([email])
  @@index([support_type])
  @@index([status])
  @@index([priority])
  @@index([assigned_to])
  @@index([related_transaction_id])
  @@index([related_registration_progress_id])
  @@index([createdAt])
  @@index([resolved_at])
}

// Support Ticket Conversation Messages
model SupportMessage {
  id String @id @default(uuid())

  // Ticket relation
  ticket_id String
  ticket    SupportTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)

  // Message content
  message      String  @db.Text // The actual message content
  is_internal  Boolean @default(false) // If true, only visible to support team (not user)
  is_from_user Boolean @default(true) // true = from user, false = from support team

  // Sender information
  user_id      String? // User ID if message is from registered user
  user         User?   @relation("UserSupportMessages", fields: [user_id], references: [id], onDelete: SetNull)
  sender_name  String? // Name of sender (for unregistered users or support agents)
  sender_email String? // Email of sender

  // Attachments
  attachments Json? // Array of attachment URLs/metadata

  // Metadata
  ip_address String? // IP address of sender
  user_agent String? // User agent

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticket_id])
  @@index([user_id])
  @@index([is_internal])
  @@index([is_from_user])
  @@index([createdAt])
}

// Support Type Enum
enum SupportType {
  REGISTRATION_ISSUE
  LOGIN_ISSUE
  TRANSACTION_ISSUE
  PAYMENT_ISSUE
  ACCOUNT_ISSUE
  WALLET_ISSUE
  CARD_ISSUE
  KYC_VERIFICATION_ISSUE
  SECURITY_ISSUE
  FEATURE_REQUEST
  BUG_REPORT
  BILLING_ISSUE
  REFUND_REQUEST
  GENERAL_INQUIRY
  OTHER
}

// Ticket Status Enum
enum TicketStatus {
  pending // Ticket created, awaiting support team response
  in_progress // Support team is actively working on it
  waiting_user // Waiting for user response/information
  resolved // Issue has been resolved
  closed // Ticket closed (resolved or cancelled)
  escalated // Escalated to senior support or management
}

// Ticket Priority Enum
enum TicketPriority {
  low // Non-urgent, can be handled in normal queue
  medium // Standard priority
  high // Important, needs attention soon
  urgent // Critical, needs immediate attention
}

// Account Tier Model
model Tier {
  id          String  @id @default(uuid())
  tier        String  @unique // e.g., "UNVERIFIED", "VERIFIED", "PREMIUM"
  name        String // e.g., "Basic Tier", "Verified Tier"
  description String?
  is_active   Boolean @default(true)

  // Requirements (stored as JSON array)
  requirements Json @default("[]")

  // Transaction limits
  single_transaction_limit Float @default(0)
  daily_limit              Float @default(0)
  monthly_limit            Float @default(0)
  airtime_daily_limit      Float @default(0)

  // Metadata
  metadata Json? @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users User[] @relation("UserTier")

  @@index([tier])
  @@index([is_active])
}
